services:
    postgres:
        image: postgres:15
        environment:
            POSTGRES_DB: justfeed
            POSTGRES_USER: justfeed_user
            POSTGRES_PASSWORD: justfeed_pass
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - labnet
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U justfeed_user -d justfeed"]
            interval: 5s
            timeout: 5s
            retries: 5

    service_a:
        image: ghcr.io/nathan-f04/loginservicejustfeed/service_a:latest
        command: uvicorn login_service.login:app --host 0.0.0.0 --port 8000
        environment:
            DATABASE_URL: "postgresql://justfeed_user:justfeed_pass@postgres:5432/justfeed"
            RABBIT_URL: "amqp://guest:guest@rabbitmq:5672/"
        ports:
            - "8001:8000"
        depends_on:
            postgres:
                condition: service_healthy
        restart: on-failure
        networks:
            - labnet

    rabbitmq:
        image: rabbitmq:3-management
        environment:
            RABBITMQ_DEFAULT_USER: guest
            RABBITMQ_DEFAULT_PASS: guest
        ports:
            - "5672:5672"
            - "15672:15672"
        networks:
            - labnet
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    service_b:
        image: ghcr.io/nathan-f04/bankingservicejustfeed/service_b:latest
        command: uvicorn banking_service.banking:app --host 0.0.0.0 --port 8000
        depends_on:
            postgres:
                condition: service_healthy
        restart: on-failure
        environment:
            DATABASE_URL: "postgresql://justfeed_user:justfeed_pass@postgres:5432/justfeed"
        ports:
            - "8002:8000"
        networks:
            - labnet

    service_c:
        image: ghcr.io/nathan-f04/notificationservicejustfeed/service_c:latest
        command: uvicorn notification_service.notification:app --host 0.0.0.0 --port 8000
        depends_on:
            rabbitmq:
                condition: service_healthy
        environment:
            RABBIT_URL: "amqp://guest:guest@rabbitmq:5672/"
        ports:
            - "8080:8000"
        networks:
            - labnet

    service_d:
        image: ghcr.io/nathan-f04/orderservicejustfeed/service_d:abb385ede994da09d583aef7cc9b13ae0fee16e3
        command: uvicorn order_service.orders:app --host 0.0.0.0 --port 8000
        depends_on:
            postgres:
                condition: service_healthy
        restart: on-failure
        environment:
            DATABASE_URL: "postgresql://justfeed_user:justfeed_pass@postgres:5432/justfeed"
            RABBIT_URL: "amqp://guest:guest@rabbitmq:5672/"
        ports:
            - "8004:8000"
        networks:
            - labnet

    service_e:
        image: ghcr.io/nathan-f04/frontendjustfeed/service_e:f34ff31f2870fbfa5a6f24f75a61b2fec937c7ea
        depends_on:
            service_a:
                condition: service_started
            service_b:
                condition: service_started
            service_c:
                condition: service_started
            service_d:
                condition: service_started
        environment:
            NEXT_PUBLIC_LOGIN_API_URL: "http://service_a:8000"
            NEXT_PUBLIC_BANKING_API_URL: "http://service_b:8000"
            NEXT_PUBLIC_NOTIFICATION_API_URL: "http://service_c:8000"
            NEXT_PUBLIC_ORDER_API_URL: "http://service_d:8000"
            LOGIN_API_URL: "http://service_a:8000"
            BANKING_API_URL: "http://service_b:8000"
            NOTIFICATION_API_URL: "http://service_c:8000"
            ORDER_API_URL: "http://service_d:8000"
            NODE_OPTIONS: "--dns-result-order=ipv4first"
        ports:
            - "3000:3000"
        networks:
            - labnet
        restart: on-failure

networks:
    labnet:

volumes:
    postgres_data: